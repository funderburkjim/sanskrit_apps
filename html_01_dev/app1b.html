<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>TSV Viewer</title>
 <style>
  table, th, td {
   border: 1px solid black;
   border-collapse: collapse;
   padding: 4px;
  }
  #dropzone {
   border: 2px dashed #666;
   padding: 20px;
   width: 300px;
   margin-top: 10px;
   text-align: center;
   color: #444;
  }
  #dropzone.dragover {
   background: #eef;
   border-color: #00f;
  }
  #recentList {
   margin-top: 10px;
  }
 </style>
</head>
<body>
 <h2>TSV Viewer</h2>

 <div>
  <label>Select TSV file: </label>
  <input id="fileInput" type="file" accept=".tsv">
 </div>

 <div id="dropzone">Drop TSV file here</div>

 <p id="paramInfo"></p>

 <div id="filters"></div>

 <div id="recentList"></div>

 <div id="output"></div>

 <script>
  function getParam(name) {
   let url = new URL(window.location.href);
   return url.searchParams.get(name);
  }

  function parseTSV(text) {
   let lines = text.trim().split(/\r?\n/);
   return lines.map(line => line.split("\t"));
  }

  function renderTable(rows) {
   if (rows.length === 0) return "";

   let html = "<table>";

   html += "<tr>";
   for (let cell of rows[0]) {
    html += "<th>" + cell + "</th>";
   }
   html += "</tr>";

   for (let i = 1; i < rows.length; i++) {
    html += "<tr>";
    for (let cell of rows[i]) {
     html += "<td>" + cell + "</td>";
    }
    html += "</tr>";
   }

   html += "</table>";
   return html;
  }

  function buildFilters(rows) {
   if (rows.length < 2) return;

   let header = rows[0];
   let data = rows.slice(1);

   let attrCount = header.length - 1;

   let container = document.getElementById("filters");
   if (!container) return;
   container.innerHTML = "<h3>Filters</h3>";

   for (let col = 0; col < attrCount; col++) {
    let values = new Set();
    for (let row of data) values.add(row[col]);

    let id = "filter_" + col;

    let html = "<div>";
    html += "<b>" + header[col] + ":</b><br>";
    html += "<select id='" + id + "' multiple size='4'>";

    for (let v of Array.from(values).sort()) {
     html += "<option value='" + v + "'>" + v + "</option>";
    }

    html += "</select>";
    html += "</div>";

    container.innerHTML += html;
   }

   for (let col = 0; col < attrCount; col++) {
    let el = document.getElementById("filter_" + col);
    if (el) el.addEventListener("change", applyFilters);
   }
  }

  function applyFilters() {
   if (!window.fullRows) return;

   let rows = window.fullRows;
   let header = rows[0];
   let data = rows.slice(1);

   let attrCount = header.length - 1;

   let selected = [];
   for (let col = 0; col < attrCount; col++) {
    let selEl = document.getElementById("filter_" + col);
    if (!selEl) {
     selected.push([]);
     continue;
    }
    let sel = Array.from(selEl.selectedOptions).map(o => o.value);
    selected.push(sel);
   }

   let filtered = [header];
   for (let row of data) {
    let ok = true;
    for (let col = 0; col < attrCount; col++) {
     if (selected[col].length > 0 && !selected[col].includes(row[col])) {
      ok = false;
      break;
     }
    }
    if (ok) filtered.push(row);
   }

   document.getElementById("output").innerHTML = renderTable(filtered);
  }

  function loadTSVFile(file) {
   let reader = new FileReader();
   reader.onload = function(e) {
    let text = e.target.result;
    let rows = parseTSV(text);

    window.fullRows = rows;

    buildFilters(rows);
    document.getElementById("output").innerHTML = renderTable(rows);

    addRecent(file.name);
   };
   reader.readAsText(file);
  }

  function addRecent(name) {
   let list = JSON.parse(localStorage.getItem("recentTSV") || "[]");
   if (!list.includes(name)) {
    list.unshift(name);
    list = list.slice(0, 5);
    localStorage.setItem("recentTSV", JSON.stringify(list));
   }
   showRecent();
  }

  function showRecent() {
   let list = JSON.parse(localStorage.getItem("recentTSV") || "[]");
   if (list.length === 0) {
    document.getElementById("recentList").innerHTML = "";
    return;
   }
   let html = "<b>Recent files:</b><ul>";
   for (let name of list) html += "<li>" + name + "</li>";
   html += "</ul>";
   document.getElementById("recentList").innerHTML = html;
  }

  window.addEventListener("DOMContentLoaded", function() {
   let fileInput = document.getElementById("fileInput");
   if (fileInput) {
    fileInput.addEventListener("change", function(evt) {
     let file = evt.target.files[0];
     if (file) loadTSVFile(file);
    });
   }

   let dz = document.getElementById("dropzone");
   if (dz) {
    dz.addEventListener("dragover", function(evt) {
     evt.preventDefault();
     dz.classList.add("dragover");
    });
    dz.addEventListener("dragleave", function(evt) {
     dz.classList.remove("dragover");
    });
    dz.addEventListener("drop", function(evt) {
     evt.preventDefault();
     dz.classList.remove("dragover");
     let file = evt.dataTransfer.files[0];
     if (file && file.name.endsWith(".tsv")) loadTSVFile(file);
    });
   }

   let paramFile = getParam("file");
   if (paramFile) {
    document.getElementById("paramInfo").textContent =
     "URL parameter suggests file: " + paramFile +
     " (please select or drop it manually)";
   }

   showRecent();
  });
 </script>
</body>
</html>
