<!DOCTYPE html>
<html>
<head>
 <meta charset="UTF-8">
 <title>TSV Viewer</title>
 <style>
  table {
   border-collapse: collapse;
   width: 100%;
  }
  th, td {
   border: 1px solid black;
   padding: 4px;
  }
  th {
   position: sticky;
   top: 0;
   background: #f0f0f0;
   z-index: 2;
  }

  #grid {
   display: grid;
   grid-template-columns: 1fr 1fr;
   grid-template-rows: auto 1fr;
   grid-template-areas:
    "loader drop"
    "table  filters";
   gap: 15px;
   margin-top: 10px;
  }

  #localLoader {
   grid-area: loader;
  }

  #serverPicker {
   grid-area: loader;
  }

  #dropzone {
   grid-area: drop;
   border: 2px dashed #666;
   padding: 20px;
   text-align: center;
   color: #444;
  }
  #dropzone.dragover {
   background: #eef;
   border-color: #00f;
  }

  #tableContainer {
   grid-area: table;
   height: 500px;
   overflow-y: scroll;
   border: 1px solid #ccc;
   padding: 5px;
  }

  #filtersArea {
   grid-area: filters;
   display: grid;
   grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
   gap: 12px;
   height: 100%;
   align-content: start;
  }

  #activeFilters {
   grid-column: 1 / -1;
   padding: 6px;
   border: 1px solid #ccc;
   background: #f8f8f8;
  }

  /* Loading overlay */
  #loadingOverlay {
   position: fixed;
   top: 0;
   left: 0;
   width: 100%;
   height: 100%;
   background: rgba(255,255,255,0.85);
   display: none;
   align-items: center;
   justify-content: center;
   font-size: 28px;
   font-weight: bold;
   color: #333;
   z-index: 9999;
  }
 </style>
</head>
<body>
 <h2>TSV Viewer</h2>

 <div id="grid">
  <!-- Row 1, Col 1 (loader area) -->
  <div id="localLoader">
   <label>Select TSV file: </label>
   <input id="fileInput" type="file" accept=".tsv">
   <p id="paramInfo"></p>
  </div>

  <!-- Server-mode loader -->
  <div id="serverPicker" style="display:none;">
   <label for="serverFileSelect">Choose TSV file:</label>
   <select id="serverFileSelect"></select>
   <button id="loadServerFile">Load</button>
  </div>

  <!-- Row 1, Col 2 (drop area) -->
  <div id="dropzone">Drop TSV file here</div>

  <!-- Row 2, Col 1 (table) -->
  <div id="tableContainer">
   <div id="output"></div>
  </div>

  <!-- Row 2, Col 2 (filters) -->
  <div id="filtersArea">
   <div id="activeFilters"></div>
  </div>
 </div>

 <!-- Loading overlay -->
 <div id="loadingOverlay">Loadingâ€¦</div>

 <script>
  const overlay = document.getElementById("loadingOverlay");
  function showLoading() { overlay.style.display = "flex"; }
  function hideLoading() { overlay.style.display = "none"; }

  function getParam(name) {
   let url = new URL(window.location.href);
   return url.searchParams.get(name);
  }

  function parseTSV(text) {
   let lines = text.trim().split(/\r?\n/);
   return lines.map(line => line.split("\t"));
  }

  function renderTable(rows) {
   if (rows.length === 0) return "";
   let html = "<table>";

   html += "<tr>";
   for (let cell of rows[0]) html += "<th>" + cell + "</th>";
   html += "</tr>";

   for (let i = 1; i < rows.length; i++) {
    html += "<tr>";
    for (let cell of rows[i]) html += "<td>" + cell + "</td>";
    html += "</tr>";
   }

   html += "</table>";
   return html;
  }

  function buildFilters(rows) {
   let header = rows[0];
   let data = rows.slice(1);
   let attrCount = header.length - 1;

   let container = document.getElementById("filtersArea");
   container.innerHTML = "<div id='activeFilters'></div>";

   for (let col = 0; col < attrCount; col++) {
    let values = new Set();
    for (let row of data) values.add(row[col]);

    let id = "filter_" + col;

    let html = "<div>";
    html += "<b>" + header[col] + "</b><br>";
    html += "<select id='" + id + "' multiple size='5' style='width:140px;'>";

    for (let v of Array.from(values).sort()) {
     html += "<option value='" + v + "'>" + v + "</option>";
    }

    html += "</select>";
    html += "</div>";

    container.innerHTML += html;
   }

   for (let col = 0; col < attrCount; col++) {
    let el = document.getElementById("filter_" + col);
    if (el) el.addEventListener("change", applyFilters);
   }
  }

  function updateActiveFilters(selected, header, count) {
   let div = document.getElementById("activeFilters");
   let html = "<b>" + count + " rows selected</b><br>";
   html += "<b>Active filters:</b><br>";

   let any = false;
   for (let i = 0; i < selected.length; i++) {
    if (selected[i].length > 0) {
     any = true;
     html += header[i] + ": " + selected[i].join(", ") + "<br>";
    }
   }

   if (!any) html += "<i>None</i>";
   div.innerHTML = html;
  }

  function applyFilters() {
   if (!window.fullRows) return;

   let rows = window.fullRows;
   let header = rows[0];
   let data = rows.slice(1);
   let attrCount = header.length - 1;

   let selected = [];
   for (let col = 0; col < attrCount; col++) {
    let selEl = document.getElementById("filter_" + col);
    let sel = Array.from(selEl.selectedOptions).map(o => o.value);
    selected.push(sel);
   }

   let filtered = [header];
   for (let row of data) {
    let ok = true;
    for (let col = 0; col < attrCount; col++) {
     if (selected[col].length > 0 && !selected[col].includes(row[col])) {
      ok = false;
      break;
     }
    }
    if (ok) filtered.push(row);
   }

   updateActiveFilters(selected, header, filtered.length - 1);
   document.getElementById("output").innerHTML = renderTable(filtered);
  }

  function loadTSVText(text, filename) {
   let rows = parseTSV(text);
   window.fullRows = rows;

   buildFilters(rows);

   let header = rows[0];
   let attrCount = header.length - 1;
   let emptySelected = Array.from({ length: attrCount }, () => []);
   updateActiveFilters(emptySelected, header, rows.length - 1);

   document.getElementById("output").innerHTML = renderTable(rows);

   hideLoading();
  }

  function loadTSVFile(file) {
   showLoading();
   let reader = new FileReader();
   reader.onload = e => loadTSVText(e.target.result, file.name);
   reader.readAsText(file);
  }

  window.addEventListener("DOMContentLoaded", function() {
   const isLocal = location.protocol === "file:";
   const localLoader = document.getElementById("localLoader");
   const dropzone = document.getElementById("dropzone");
   const serverPicker = document.getElementById("serverPicker");

   if (isLocal) {
    localLoader.style.display = "block";
    dropzone.style.display = "block";
    serverPicker.style.display = "none";

    let fileInput = document.getElementById("fileInput");
    fileInput.addEventListener("change", evt => {
     let file = evt.target.files[0];
     if (file) {
      document.getElementById("paramInfo").textContent =
        "Loaded file: " + file.name;
      loadTSVFile(file);
     }
    });

    dropzone.addEventListener("dragover", evt => {
     evt.preventDefault();
     dropzone.classList.add("dragover");
    });
    dropzone.addEventListener("dragleave", evt => {
     dropzone.classList.remove("dragover");
    });
    dropzone.addEventListener("drop", evt => {
     evt.preventDefault();
     dropzone.classList.remove("dragover");
     let file = evt.dataTransfer.files[0];
     if (file && file.name.endsWith(".tsv")) {
      document.getElementById("paramInfo").textContent =
        "Loaded file: " + file.name;
      loadTSVFile(file);
     }
    });

   } else {
    localLoader.style.display = "none";
    dropzone.style.display = "none";
    serverPicker.style.display = "block";

    fetch("data/manifest.json")
     .then(r => r.json())
     .then(files => {
      const sel = document.getElementById("serverFileSelect");
      files.forEach(f => {
       if (f.endsWith(".tsv")) {
        let opt = document.createElement("option");
        opt.value = f;
        opt.textContent = f;
        sel.appendChild(opt);
       }
      });
     });

    document.getElementById("loadServerFile").addEventListener("click", () => {
     const filename = document.getElementById("serverFileSelect").value;
     if (!filename) return;

     showLoading();

     fetch("data/" + filename)
      .then(r => r.text())
      .then(text => loadTSVText(text, filename));
    });
   }

   let paramFile = getParam("file");
   if (paramFile) {
    document.getElementById("paramInfo").textContent =
     "URL parameter suggests file: " + paramFile +
     " (please select or drop it manually)";
   }
  });
 </script>
</body>
</html>
